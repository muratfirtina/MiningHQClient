<div class="modern-production-page">
  
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <button class="back-btn" (click)="back()">
        <i class="fas fa-arrow-left"></i>
        <span>Geri</span>
      </button>
      <div class="page-title">
        <h1>
          <i class="fas fa-chart-line"></i>
          Üretim Takibi
        </h1>
        <p *ngIf="quarry">
          <i class="fas fa-mountain"></i>
          {{quarry.name}}
        </p>
      </div>
      <button class="add-btn" (click)="toggleAddForm()">
        <i class="fas" [class.fa-plus]="!showAddForm" [class.fa-times]="showAddForm"></i>
        <span>{{showAddForm ? 'İptal' : 'Yeni Kayıt'}}</span>
      </button>
    </div>
  </div>

  <div class="container-fluid">
    
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card primary">
        <div class="stat-icon">
          <i class="fas fa-industry"></i>
        </div>
        <div class="stat-content">
          <span class="stat-label">Toplam Üretim</span>
          <span class="stat-value">{{totalProduction | number:'1.0-2'}} ton</span>
        </div>
      </div>

      <div class="stat-card warning">
        <div class="stat-icon">
          <i class="fas fa-boxes"></i>
        </div>
        <div class="stat-content">
          <span class="stat-label">Toplam Stok</span>
          <span class="stat-value">{{totalStock | number:'1.0-2'}} ton</span>
        </div>
      </div>

      <div class="stat-card success">
        <div class="stat-icon">
          <i class="fas fa-hand-holding-usd"></i>
        </div>
        <div class="stat-content">
          <span class="stat-label">Toplam Satış</span>
          <span class="stat-value">{{totalSales | number:'1.0-2'}} ton</span>
        </div>
      </div>

      <div class="stat-card info">
        <div class="stat-icon">
          <i class="fas fa-chart-bar"></i>
        </div>
        <div class="stat-content">
          <span class="stat-label">Ortalama Üretim</span>
          <span class="stat-value">{{averageProduction | number:'1.0-2'}} ton</span>
        </div>
      </div>
    </div>

    <!-- Add Production Form -->
    <div class="add-form-card" *ngIf="showAddForm">
      <div class="form-header">
        <h3>
          <i class="fas fa-plus-circle"></i>
          Yeni Üretim Kaydı
        </h3>
      </div>
      
      <form class="production-form">
        <div class="form-grid">
          
          <!-- Date Range -->
          <div class="form-group">
            <label for="weekStartDate">
              <i class="fas fa-calendar-alt"></i>
              Hafta Başlangıcı
            </label>
            <input type="date" 
                   id="weekStartDate" 
                   [(ngModel)]="newProduction.weekStartDate" 
                   name="weekStartDate"
                   class="form-input">
          </div>

          <div class="form-group">
            <label for="weekEndDate">
              <i class="fas fa-calendar-alt"></i>
              Hafta Bitişi
            </label>
            <input type="date" 
                   id="weekEndDate" 
                   [(ngModel)]="newProduction.weekEndDate" 
                   name="weekEndDate"
                   class="form-input">
          </div>

          <!-- Production -->
          <div class="form-group">
            <label for="productionAmount">
              <i class="fas fa-industry"></i>
              Üretim Miktarı
            </label>
            <div class="input-group">
              <input type="number" 
                     id="productionAmount" 
                     [(ngModel)]="newProduction.productionAmount" 
                     name="productionAmount"
                     class="form-input"
                     placeholder="0">
              <select [(ngModel)]="newProduction.productionUnit" 
                      name="productionUnit"
                      class="form-select">
                <option value="ton">ton</option>
                <option value="m³">m³</option>
                <option value="kg">kg</option>
              </select>
            </div>
          </div>

          <!-- Stock -->
          <div class="form-group">
            <label for="stockAmount">
              <i class="fas fa-boxes"></i>
              Stok Miktarı
            </label>
            <div class="input-group">
              <input type="number" 
                     id="stockAmount" 
                     [(ngModel)]="newProduction.stockAmount" 
                     name="stockAmount"
                     class="form-input"
                     placeholder="0">
              <select [(ngModel)]="newProduction.stockUnit" 
                      name="stockUnit"
                      class="form-select">
                <option value="ton">ton</option>
                <option value="m³">m³</option>
                <option value="kg">kg</option>
              </select>
            </div>
          </div>

          <!-- Sales -->
          <div class="form-group">
            <label for="salesAmount">
              <i class="fas fa-hand-holding-usd"></i>
              Satış Miktarı
            </label>
            <div class="input-group">
              <input type="number" 
                     id="salesAmount" 
                     [(ngModel)]="newProduction.salesAmount" 
                     name="salesAmount"
                     class="form-input"
                     placeholder="0">
              <select [(ngModel)]="newProduction.salesUnit" 
                      name="salesUnit"
                      class="form-select">
                <option value="ton">ton</option>
                <option value="m³">m³</option>
                <option value="kg">kg</option>
              </select>
            </div>
          </div>

          <!-- Notes -->
          <div class="form-group full-width">
            <label for="notes">
              <i class="fas fa-sticky-note"></i>
              Notlar
            </label>
            <textarea id="notes" 
                      [(ngModel)]="newProduction.notes" 
                      name="notes"
                      class="form-textarea"
                      rows="2"
                      placeholder="Ek açıklama veya notlar..."></textarea>
          </div>
          
          <!-- Location Section Header -->
          <div class="form-section-header full-width">
            <h4>
              <i class="fas fa-map-marker-alt"></i>
              Üretim Konumu (UTM 35T)
            </h4>
            <p>Sahadan aldığınız UTM koordinatlarını giriniz</p>
          </div>
          
          <!-- UTM Easting -->
          <div class="form-group">
            <label for="utmEasting">
              <i class="fas fa-arrows-alt-h"></i>
              UTM Doğruluk (X)
            </label>
            <input type="number" 
                   id="utmEasting" 
                   [(ngModel)]="newProduction.utmEasting" 
                   name="utmEasting"
                   class="form-input"
                   placeholder="Örn: 537824"
                   step="0.01">
          </div>
          
          <!-- UTM Northing -->
          <div class="form-group">
            <label for="utmNorthing">
              <i class="fas fa-arrows-alt-v"></i>
              UTM Kuzeyleme (Y)
            </label>
            <input type="number" 
                   id="utmNorthing" 
                   [(ngModel)]="newProduction.utmNorthing" 
                   name="utmNorthing"
                   class="form-input"
                   placeholder="Örn: 4398652"
                   step="0.01">
          </div>
          
          <!-- Altitude -->
          <div class="form-group">
            <label for="altitude">
              <i class="fas fa-mountain"></i>
              Yükseklik (m)
            </label>
            <input type="number" 
                   id="altitude" 
                   [(ngModel)]="newProduction.altitude" 
                   name="altitude"
                   class="form-input"
                   placeholder="Örn: 850"
                   step="0.1">
          </div>
          
          <!-- Pafta -->
          <div class="form-group">
            <label for="pafta">
              <i class="fas fa-map"></i>
              Pafta
            </label>
            <input type="text" 
                   id="pafta" 
                   [(ngModel)]="newProduction.pafta" 
                   name="pafta"
                   class="form-input"
                   placeholder="Örn: L37-c3">
          </div>
          
          <!-- Coordinate Description -->
          <div class="form-group full-width">
            <label for="coordinateDescription">
              <i class="fas fa-info-circle"></i>
              Konum Açıklaması
            </label>
            <input type="text" 
                   id="coordinateDescription" 
                   [(ngModel)]="newProduction.coordinateDescription" 
                   name="coordinateDescription"
                   class="form-input"
                   placeholder="Örn: Kuzey Basamak, 3. Kademe">
          </div>

        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="toggleAddForm()">
            <i class="fas fa-times"></i>
            İptal
          </button>
          <button type="button" class="btn btn-primary" (click)="saveProduction()">
            <i class="fas fa-save"></i>
            Kaydet
          </button>
        </div>
      </form>
    </div>

    <!-- Productions Table -->
    <div class="table-card">
      <div class="table-header">
        <h3>
          <i class="fas fa-list"></i>
          Üretim Kayıtları
        </h3>
        <span class="record-count">{{productions.length}} kayıt</span>
      </div>

      <div class="table-container" *ngIf="productions && productions.length > 0">
        <table class="modern-table">
          <thead>
            <tr>
              <th>#</th>
              <th>
                <i class="fas fa-calendar"></i>
                Hafta
              </th>
              <th>
                <i class="fas fa-industry"></i>
                Üretim
              </th>
              <th>
                <i class="fas fa-boxes"></i>
                Stok
              </th>
              <th>
                <i class="fas fa-hand-holding-usd"></i>
                Satış
              </th>
              <th>
                <i class="fas fa-percentage"></i>
                Verimlilik
              </th>
              <th>
                <i class="fas fa-map-marker-alt"></i>
                Konum
              </th>
              <th>
                <i class="fas fa-cog"></i>
                İşlemler
              </th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let production of productions; let i = index">
              <td>
                <span class="row-number">{{i + 1}}</span>
              </td>
              <td>
                <div class="date-range">
                  <span class="date-start">{{production.weekStartDate | date:'dd.MM.yyyy'}}</span>
                  <i class="fas fa-arrow-right"></i>
                  <span class="date-end">{{production.weekEndDate | date:'dd.MM.yyyy'}}</span>
                </div>
              </td>
              <td>
                <span class="amount-badge production">
                  {{production.productionAmount | number:'1.0-2'}} {{production.productionUnit}}
                </span>
              </td>
              <td>
                <span class="amount-badge stock">
                  {{production.stockAmount | number:'1.0-2'}} {{production.stockUnit}}
                </span>
              </td>
              <td>
                <span class="amount-badge sales">
                  {{production.salesAmount | number:'1.0-2'}} {{production.salesUnit}}
                </span>
              </td>
              <td>
                <div class="efficiency-cell">
                  <div class="efficiency-bar">
                    <div class="efficiency-fill" 
                         [style.width.%]="getEfficiencyPercentage(production)"
                         [ngClass]="getEfficiencyClass(getEfficiencyPercentage(production))">
                    </div>
                  </div>
                  <span class="efficiency-text">
                    {{getEfficiencyPercentage(production) | number:'1.0-1'}}%
                  </span>
                </div>
              </td>
              <td>
                <div class="location-cell">
                  <span *ngIf="production.latitude && production.longitude" class="location-available">
                    <i class="fas fa-check-circle"></i>
                    Var
                  </span>
                  <span *ngIf="!production.latitude || !production.longitude" class="location-unavailable">
                    <i class="fas fa-times-circle"></i>
                    Yok
                  </span>
                </div>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn-icon map" 
                          *ngIf="production.latitude && production.longitude"
                          (click)="showProductionMap(production)"
                          title="Haritada Göster">
                    <i class="fas fa-map"></i>
                  </button>
                  <span *ngIf="!production.latitude || !production.longitude" 
                        class="no-map-text"
                        title="Konum bilgisi yok">
                    -
                  </span>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="!productions || productions.length === 0" class="empty-state">
        <div class="empty-icon">
          <i class="fas fa-chart-line"></i>
        </div>
        <h3>Henüz üretim kaydı yok</h3>
        <p>Yeni üretim kaydı eklemek için yukarıdaki "Yeni Kayıt" butonuna tıklayın</p>
        <button class="btn btn-primary" (click)="toggleAddForm()">
          <i class="fas fa-plus"></i>
          İlk Kaydı Ekle
        </button>
      </div>
    </div>

  </div>
</div>

<!-- Map Modal -->
<div class="map-modal" *ngIf="selectedProduction" (click)="closeMap()">
  <div class="map-modal-content" (click)="$event.stopPropagation()">
    <div class="map-modal-header">
      <h3>
        <i class="fas fa-map-marker-alt"></i>
        Üretim Konumu
      </h3>
      <button class="close-btn" (click)="closeMap()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="map-modal-body">
      <div class="location-info">
        <div class="info-item">
          <strong>Hafta:</strong>
          {{selectedProduction.weekStartDate | date:'dd.MM.yyyy'}} - 
          {{selectedProduction.weekEndDate | date:'dd.MM.yyyy'}}
        </div>
        <div class="info-item" *ngIf="selectedProduction.utmEasting && selectedProduction.utmNorthing">
          <strong>UTM:</strong>
          X: {{selectedProduction.utmEasting | number:'1.2-2'}}, 
          Y: {{selectedProduction.utmNorthing | number:'1.2-2'}}
        </div>
        <div class="info-item" *ngIf="selectedProduction.altitude">
          <strong>Yükseklik:</strong>
          {{selectedProduction.altitude}} m
        </div>
        <div class="info-item" *ngIf="selectedProduction.pafta">
          <strong>Pafta:</strong>
          {{selectedProduction.pafta}}
        </div>
        <div class="info-item" *ngIf="selectedProduction.coordinateDescription">
          <strong>Açıklama:</strong>
          {{selectedProduction.coordinateDescription}}
        </div>
      </div>
      <iframe 
        [src]="getProductionMapUrl() | safe: 'resourceUrl'" 
        width="100%" 
        height="500" 
        style="border:0;border-radius:12px;margin-top:1rem;" 
        allowfullscreen="" 
        loading="lazy">
      </iframe>
      <div class="map-actions">
        <a [href]="'https://www.google.com/maps?q=' + selectedProduction.latitude + ',' + selectedProduction.longitude" 
           target="_blank" 
           class="btn btn-primary">
          <i class="fas fa-external-link-alt"></i>
          Google Maps'te Aç
        </a>
      </div>
    </div>
  </div>
</div>
