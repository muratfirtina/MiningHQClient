<div class="users-container">
  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header-custom">
        <div class="header-content">
          <i class="pi pi-users" style="font-size: 1.5rem; color: white;"></i>
          <div class="header-text">
            <h2>Kullanıcı Yönetimi</h2>
            <p class="header-subtitle">Kullanıcıları yönetin, rol ve yetki atayın</p>
          </div>
        </div>
      </div>
    </ng-template>

    <p-toolbar styleClass="mb-4">
      <ng-template pTemplate="left">
        <button
          pButton
          pRipple
          label="Yeni Kullanıcı"
          icon="pi pi-user-plus"
          class="p-button-success"
          (click)="openCreateDialog()"
          pTooltip="Yeni kullanıcı ekle"
          tooltipPosition="bottom">
        </button>
      </ng-template>

      <ng-template pTemplate="right">
        <button
          pButton
          pRipple
          icon="pi pi-refresh"
          class="p-button-help"
          (click)="loadUsers()"
          pTooltip="Listeyi yenile"
          tooltipPosition="bottom">
        </button>
      </ng-template>
    </p-toolbar>

    <p-table
      [value]="users"
      [paginator]="true"
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [lazy]="true"
      (onLazyLoad)="onPageChange($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="{first} - {last} arası, toplam {totalRecords} kullanıcı"
      [rowsPerPageOptions]="[5, 10, 25, 50]"
      [tableStyle]="{ 'min-width': '60rem' }"
      styleClass="p-datatable-gridlines p-datatable-striped">

      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5%">#</th>
          <th style="width: 20%">Ad Soyad</th>
          <th style="width: 20%">Email</th>
          <th style="width: 25%">Roller</th>
          <th style="width: 20%">Ekstra Yetkiler</th>
          <th style="width: 10%">İşlemler</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-user let-rowIndex="rowIndex">
        <tr>
          <td>{{ pageIndex * pageSize + rowIndex + 1 }}</td>
          <td>
            <div class="user-info">
              <i class="pi pi-user user-icon"></i>
              <strong>{{ user.firstName }} {{ user.lastName }}</strong>
            </div>
          </td>
          <td>
            <div class="email-info">
              <i class="pi pi-envelope"></i>
              <span>{{ user.email }}</span>
            </div>
          </td>
          <td>
            <div class="roles-container">
              <p-chip
                *ngFor="let role of getUserRoles(user.id)"
                [label]="role.name"
                styleClass="role-chip">
              </p-chip>
              <span *ngIf="getUserRoles(user.id).length === 0" class="no-data">
                <i class="pi pi-info-circle"></i> Rol atanmamış
              </span>
            </div>
          </td>
          <td>
            <div class="claims-container">
              <p-chip
                *ngFor="let claim of getUserExtraClaims(user.id)"
                [label]="claim.name"
                styleClass="claim-chip">
              </p-chip>
              <span *ngIf="getUserExtraClaims(user.id).length === 0" class="no-data">
                <i class="pi pi-minus-circle"></i> Yok
              </span>
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <button
                pButton
                pRipple
                icon="pi pi-pencil"
                class="p-button-rounded p-button-warning p-button-text"
                (click)="openEditDialog(user)"
                pTooltip="Düzenle"
                tooltipPosition="top">
              </button>
              <button
                pButton
                pRipple
                icon="pi pi-trash"
                class="p-button-rounded p-button-danger p-button-text"
                (click)="confirmDelete(user)"
                pTooltip="Sil"
                tooltipPosition="top">
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center">
            <div class="empty-message">
              <i class="pi pi-info-circle" style="font-size: 3rem; color: var(--text-color-secondary);"></i>
              <p>Henüz kullanıcı bulunmamaktadır.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Modern Create/Edit Dialog -->
<p-dialog
  [(visible)]="displayDialog"
  [modal]="true"
  [style]="{width: '800px', maxHeight: '90vh'}"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  styleClass="modern-user-dialog">

  <ng-template pTemplate="header">
    <div class="modern-dialog-header">
      <div class="header-icon-wrapper">
        <i class="pi" [ngClass]="dialogMode === 'create' ? 'pi-user-plus' : 'pi-user-edit'"></i>
      </div>
      <div class="header-text-wrapper">
        <h2>{{ getDialogHeader() }}</h2>
        <p class="header-description">{{ dialogMode === 'create' ? 'Yeni kullanıcı oluşturun ve yetkilerini atayın' : 'Kullanıcı bilgilerini ve yetkilerini güncelleyin' }}</p>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="content">
    <div class="modern-dialog-content">

      <!-- Progress Steps -->
      <div class="progress-steps">
        <div class="step-item active">
          <div class="step-circle">
            <i class="pi pi-user"></i>
          </div>
          <span class="step-label">Bilgiler</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item active">
          <div class="step-circle">
            <i class="pi pi-shield"></i>
          </div>
          <span class="step-label">Roller</span>
        </div>
        <div class="step-line"></div>
        <div class="step-item active">
          <div class="step-circle">
            <i class="pi pi-key"></i>
          </div>
          <span class="step-label">Yetkiler</span>
        </div>
      </div>

      <!-- User Info Panel -->
      <p-panel [toggleable]="false" styleClass="info-panel">
        <ng-template pTemplate="header">
          <div class="panel-header">
            <i class="pi pi-id-card"></i>
            <span>Kullanıcı Bilgileri</span>
          </div>
        </ng-template>

        <div class="form-grid">
          <div class="form-group">
            <label for="firstName" class="modern-label">
              <i class="pi pi-user label-icon"></i>
              <span>Ad <span class="required-star">*</span></span>
            </label>
            <p-inputGroup>
              <p-inputGroupAddon>
                <i class="pi pi-user"></i>
              </p-inputGroupAddon>
              <input
                id="firstName"
                type="text"
                pInputText
                [(ngModel)]="userForm.firstName"
                placeholder="Kullanıcının adını girin"
                class="modern-input"
                required>
            </p-inputGroup>
          </div>

          <div class="form-group">
            <label for="lastName" class="modern-label">
              <i class="pi pi-user label-icon"></i>
              <span>Soyad <span class="required-star">*</span></span>
            </label>
            <p-inputGroup>
              <p-inputGroupAddon>
                <i class="pi pi-user"></i>
              </p-inputGroupAddon>
              <input
                id="lastName"
                type="text"
                pInputText
                [(ngModel)]="userForm.lastName"
                placeholder="Kullanıcının soyadını girin"
                class="modern-input"
                required>
            </p-inputGroup>
          </div>

          <div class="form-group full-width">
            <label for="email" class="modern-label">
              <i class="pi pi-envelope label-icon"></i>
              <span>Email Adresi <span class="required-star">*</span></span>
            </label>
            <p-inputGroup>
              <p-inputGroupAddon>
                <i class="pi pi-at"></i>
              </p-inputGroupAddon>
              <input
                id="email"
                type="email"
                pInputText
                [(ngModel)]="userForm.email"
                placeholder="email@example.com"
                class="modern-input"
                required>
            </p-inputGroup>
          </div>

          <div class="form-group full-width" *ngIf="dialogMode === 'create'">
            <label for="password" class="modern-label">
              <i class="pi pi-lock label-icon"></i>
              <span>Şifre <span class="required-star">*</span></span>
            </label>
            <p-inputGroup>
              <p-inputGroupAddon>
                <i class="pi pi-lock"></i>
              </p-inputGroupAddon>
              <input
                id="password"
                type="password"
                pInputText
                [(ngModel)]="userForm.password"
                placeholder="Güvenli bir şifre girin"
                class="modern-input"
                required>
            </p-inputGroup>
            <small class="input-hint">
              <i class="pi pi-info-circle"></i>
              Şifre en az 8 karakter olmalıdır
            </small>
          </div>
        </div>
      </p-panel>

      <p-divider></p-divider>

      <!-- Roles Panel -->
      <p-panel [toggleable]="false" styleClass="roles-panel">
        <ng-template pTemplate="header">
          <div class="panel-header">
            <i class="pi pi-shield"></i>
            <span>Rol Atamaları</span>
          </div>
        </ng-template>

        <div class="panel-content">
          <p-message
            severity="info"
            text="Kullanıcıya atanacak rolleri seçin. Roller otomatik olarak ilgili yetkileri içerir."
            [style]="{width: '100%', marginBottom: '1rem'}">
          </p-message>

          <div class="form-group full-width">
            <label for="roles" class="modern-label">
              <i class="pi pi-users label-icon"></i>
              <span>Kullanıcı Rolleri</span>
            </label>
            <p-multiSelect
              id="roles"
              [options]="allRoles"
              [(ngModel)]="selectedRoles"
              optionLabel="name"
              placeholder="Rol seçin veya arayın..."
              [filter]="true"
              filterBy="name"
              [showClear]="true"
              [showToggleAll]="true"
              display="chip"
              [style]="{width: '100%'}"
              class="modern-multiselect">
              <ng-template let-role pTemplate="item">
                <div class="multiselect-item">
                  <div class="item-badge role-badge">
                    <i class="pi pi-shield"></i>
                  </div>
                  <div class="item-content">
                    <span class="item-title">{{ role.name }}</span>
                  </div>
                </div>
              </ng-template>
              <ng-template let-value pTemplate="selectedItems">
                <div class="selected-items-wrapper" *ngIf="value && value.length">
                  <p-chip
                    *ngFor="let role of value"
                    [label]="role.name"
                    styleClass="selected-role-chip"
                    [removable]="false">
                  </p-chip>
                </div>
                <span *ngIf="!value || value.length === 0" class="placeholder-text">
                  Rol seçilmedi
                </span>
              </ng-template>
            </p-multiSelect>
            <small class="input-hint" *ngIf="selectedRoles && selectedRoles.length > 0">
              <i class="pi pi-check-circle"></i>
              {{ selectedRoles.length }} rol seçildi
            </small>
          </div>
        </div>
      </p-panel>

      <p-divider></p-divider>

      <!-- Extra Claims Panel -->
      <p-panel [toggleable]="false" styleClass="claims-panel">
        <ng-template pTemplate="header">
          <div class="panel-header">
            <i class="pi pi-key"></i>
            <span>Ekstra Yetkiler (Opsiyonel)</span>
          </div>
        </ng-template>

        <div class="panel-content">
          <p-message
            severity="warn"
            text="Roller dışında kullanıcıya özel yetkiler atayabilirsiniz. Bu yetkiler rollerdeki yetkilerle birleşir."
            [style]="{width: '100%', marginBottom: '1rem'}">
          </p-message>

          <div class="form-group full-width">
            <label for="extraClaims" class="modern-label">
              <i class="pi pi-unlock label-icon"></i>
              <span>Ek Yetkiler</span>
            </label>
            <p-multiSelect
              id="extraClaims"
              [options]="allOperationClaims"
              [(ngModel)]="selectedExtraClaims"
              optionLabel="name"
              placeholder="Ek yetki seçin (opsiyonel)..."
              [filter]="true"
              filterBy="name"
              [showClear]="true"
              [showToggleAll]="true"
              display="chip"
              [style]="{width: '100%'}"
              class="modern-multiselect">
              <ng-template let-claim pTemplate="item">
                <div class="multiselect-item">
                  <div class="item-badge claim-badge">
                    <i class="pi pi-key"></i>
                  </div>
                  <div class="item-content">
                    <span class="item-title">{{ claim.name }}</span>
                  </div>
                </div>
              </ng-template>
              <ng-template let-value pTemplate="selectedItems">
                <div class="selected-items-wrapper" *ngIf="value && value.length">
                  <p-chip
                    *ngFor="let claim of value"
                    [label]="claim.name"
                    styleClass="selected-claim-chip"
                    [removable]="false">
                  </p-chip>
                </div>
                <span *ngIf="!value || value.length === 0" class="placeholder-text">
                  Ek yetki seçilmedi
                </span>
              </ng-template>
            </p-multiSelect>
            <small class="input-hint" *ngIf="selectedExtraClaims && selectedExtraClaims.length > 0">
              <i class="pi pi-check-circle"></i>
              {{ selectedExtraClaims.length }} ek yetki seçildi
            </small>
          </div>
        </div>
      </p-panel>

    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="modern-dialog-footer">
      <button
        pButton
        pRipple
        label="İptal"
        icon="pi pi-times"
        class="p-button-text p-button-secondary"
        (click)="hideDialog()">
      </button>
      <button
        pButton
        pRipple
        [label]="dialogMode === 'create' ? 'Kullanıcı Oluştur' : 'Değişiklikleri Kaydet'"
        [icon]="dialogMode === 'create' ? 'pi pi-user-plus' : 'pi pi-save'"
        class="p-button-success"
        (click)="saveUser()">
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Confirmation Dialog -->
<p-confirmDialog
  [style]="{width: '450px'}"
  acceptButtonStyleClass="p-button-danger"
  rejectButtonStyleClass="p-button-text">
</p-confirmDialog>
