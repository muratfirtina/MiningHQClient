<div class="users-container">
  <p-card>
    <ng-template pTemplate="header">
      <div class="card-header-custom">
        <div class="header-content">
          <i class="pi pi-users" style="font-size: 1.5rem; color: white;"></i>
          <div class="header-text">
            <h2>Kullanıcı Yönetimi</h2>
            <p class="header-subtitle">Kullanıcıları yönetin, rol ve yetki atayın</p>
          </div>
        </div>
      </div>
    </ng-template>

    <p-toolbar styleClass="mb-4">
      <ng-template pTemplate="left">
        <button
          pButton
          pRipple
          label="Yeni Kullanıcı"
          icon="pi pi-user-plus"
          class="p-button-success"
          (click)="openCreateDialog()"
          pTooltip="Yeni kullanıcı ekle"
          tooltipPosition="bottom">
        </button>
      </ng-template>

      <ng-template pTemplate="right">
        <button
          pButton
          pRipple
          icon="pi pi-refresh"
          class="p-button-help"
          (click)="loadUsers()"
          pTooltip="Listeyi yenile"
          tooltipPosition="bottom">
        </button>
      </ng-template>
    </p-toolbar>

    <p-table
      [value]="users"
      [paginator]="true"
      [rows]="pageSize"
      [totalRecords]="totalRecords"
      [lazy]="true"
      (onLazyLoad)="onPageChange($event)"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="{first} - {last} arası, toplam {totalRecords} kullanıcı"
      [rowsPerPageOptions]="[5, 10, 25, 50]"
      [tableStyle]="{ 'min-width': '60rem' }"
      styleClass="p-datatable-gridlines p-datatable-striped">

      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5%">#</th>
          <th style="width: 20%">Ad Soyad</th>
          <th style="width: 20%">Email</th>
          <th style="width: 25%">Roller</th>
          <th style="width: 20%">Ekstra Yetkiler</th>
          <th style="width: 10%">İşlemler</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-user let-rowIndex="rowIndex">
        <tr>
          <td>{{ pageIndex * pageSize + rowIndex + 1 }}</td>
          <td>
            <div class="user-info">
              <i class="pi pi-user user-icon"></i>
              <strong>{{ user.firstName }} {{ user.lastName }}</strong>
            </div>
          </td>
          <td>
            <div class="email-info">
              <i class="pi pi-envelope"></i>
              <span>{{ user.email }}</span>
            </div>
          </td>
          <td>
            <div class="roles-container">
              <p-chip
                *ngFor="let role of getUserRoles(user.id)"
                [label]="role.name"
                styleClass="role-chip">
              </p-chip>
              <span *ngIf="getUserRoles(user.id).length === 0" class="no-data">
                <i class="pi pi-info-circle"></i> Rol atanmamış
              </span>
            </div>
          </td>
          <td>
            <div class="claims-container">
              <p-chip
                *ngFor="let claim of getUserExtraClaims(user.id)"
                [label]="claim.name"
                styleClass="claim-chip">
              </p-chip>
              <span *ngIf="getUserExtraClaims(user.id).length === 0" class="no-data">
                <i class="pi pi-minus-circle"></i> Yok
              </span>
            </div>
          </td>
          <td>
            <div class="action-buttons">
              <button
                pButton
                pRipple
                icon="pi pi-pencil"
                class="p-button-rounded p-button-warning p-button-text"
                (click)="openEditDialog(user)"
                pTooltip="Düzenle"
                tooltipPosition="top">
              </button>
              <button
                pButton
                pRipple
                icon="pi pi-trash"
                class="p-button-rounded p-button-danger p-button-text"
                (click)="confirmDelete(user)"
                pTooltip="Sil"
                tooltipPosition="top">
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center">
            <div class="empty-message">
              <i class="pi pi-info-circle" style="font-size: 3rem; color: var(--text-color-secondary);"></i>
              <p>Henüz kullanıcı bulunmamaktadır.</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>
</div>

<!-- Create/Edit Dialog -->
<p-dialog
  [(visible)]="displayDialog"
  [header]="getDialogHeader()"
  [modal]="true"
  [style]="{width: '700px'}"
  [draggable]="false"
  [resizable]="false">

  <ng-template pTemplate="content">
    <div class="p-fluid">
      <!-- User Info Section -->
      <div class="section-header">
        <i class="pi pi-user"></i>
        <h4>Kullanıcı Bilgileri</h4>
      </div>

      <div class="form-row">
        <div class="field">
          <label for="firstName" class="required-field">Ad</label>
          <input
            id="firstName"
            type="text"
            pInputText
            [(ngModel)]="userForm.firstName"
            placeholder="Ad"
            required>
        </div>

        <div class="field">
          <label for="lastName" class="required-field">Soyad</label>
          <input
            id="lastName"
            type="text"
            pInputText
            [(ngModel)]="userForm.lastName"
            placeholder="Soyad"
            required>
        </div>
      </div>

      <div class="field">
        <label for="email" class="required-field">Email</label>
        <input
          id="email"
          type="email"
          pInputText
          [(ngModel)]="userForm.email"
          placeholder="email@example.com"
          required>
      </div>

      <div class="field" *ngIf="dialogMode === 'create'">
        <label for="password" class="required-field">Şifre</label>
        <input
          id="password"
          type="password"
          pInputText
          [(ngModel)]="userForm.password"
          placeholder="********"
          required>
      </div>

      <p-divider></p-divider>

      <!-- Roles Section -->
      <div class="section-header">
        <i class="pi pi-shield"></i>
        <h4>Roller</h4>
      </div>

      <div class="field">
        <label for="roles">Kullanıcı Rolleri</label>
        <p-multiSelect
          id="roles"
          [options]="allRoles"
          [(ngModel)]="selectedRoles"
          optionLabel="name"
          placeholder="Rol seçin"
          [filter]="true"
          filterBy="name"
          [showClear]="true"
          [style]="{width: '100%'}"
          display="chip">
          <ng-template let-role pTemplate="item">
            <div class="select-option">
              <i class="pi pi-shield"></i>
              <span>{{ role.name }}</span>
            </div>
          </ng-template>
        </p-multiSelect>
        <small class="p-text-secondary">Kullanıcıya atanacak roller</small>
      </div>

      <p-divider></p-divider>

      <!-- Extra Claims Section -->
      <div class="section-header">
        <i class="pi pi-key"></i>
        <h4>Ekstra Yetkiler (Opsiyonel)</h4>
      </div>

      <div class="field">
        <label for="extraClaims">Ek Yetkiler</label>
        <p-multiSelect
          id="extraClaims"
          [options]="allOperationClaims"
          [(ngModel)]="selectedExtraClaims"
          optionLabel="name"
          placeholder="Ek yetki seçin (opsiyonel)"
          [filter]="true"
          filterBy="name"
          [showClear]="true"
          [style]="{width: '100%'}"
          display="chip">
          <ng-template let-claim pTemplate="item">
            <div class="select-option">
              <i class="pi pi-key"></i>
              <span>{{ claim.name }}</span>
            </div>
          </ng-template>
        </p-multiSelect>
        <small class="p-text-secondary">Roller dışında kullanıcıya özel yetkiler</small>
      </div>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <button
      pButton
      pRipple
      label="İptal"
      icon="pi pi-times"
      class="p-button-text"
      (click)="hideDialog()">
    </button>
    <button
      pButton
      pRipple
      [label]="dialogMode === 'create' ? 'Oluştur' : 'Güncelle'"
      icon="pi pi-check"
      class="p-button-primary"
      (click)="saveUser()">
    </button>
  </ng-template>
</p-dialog>

<!-- Confirmation Dialog -->
<p-confirmDialog
  [style]="{width: '450px'}"
  acceptButtonStyleClass="p-button-danger"
  rejectButtonStyleClass="p-button-text">
</p-confirmDialog>
